<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meter Management Form</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Meter Management Form</h1>

        <!-- Password Protection Section -->
        <div id="password-section" class="space-y-4">
            <h2 class="text-xl font-semibold text-center text-gray-700">Access Required</h2>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Enter Password:</label>
                <input type="password" id="password" name="password" placeholder="Enter password"
                       class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
            </div>
            <button id="password-submit-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors shadow-md">
                Enter
            </button>
            <p id="error-message" class="text-red-500 text-sm text-center hidden">Incorrect password. Please try again.</p>
        </div>
        
        <!-- Main Form (initially hidden) -->
        <div id="form-container" class="hidden">
            <form id="meter-form" class="space-y-6" action="https://script.google.com/macros/s/AKfycbwBVxjcSMtxdeUWHXNj_Hdhyf4W552wYJrKzok3t2B03l55QaintLqvtoZJ5VkWpni_/exec" method="POST">
                <!-- Dropdown Section -->
                <div>
                    <label for="action-select" class="block text-sm font-medium text-gray-700 mb-2">Select an action:</label>
                    <select id="action-select" name="action" class="block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        <option value="" disabled selected>-- Choose an action --</option>
                        <option value="issuedByGenus">METER ISSUED BY GENUS</option>
                        <option value="issuedToSupervisor">METER ISSUED TO SUPERVISOR</option>
                        <option value="receivedFromSupervisor">METER RECEIVED FROM SUPERVISOR</option>
                    </select>
                </div>
                
                <!-- Dynamic Input Fields Section -->
                <div id="dynamic-fields-container" class="space-y-4">
                    <!-- Fields will be injected here by JavaScript -->
                </div>

                <!-- Submit Button -->
                <div id="submit-container" class="hidden pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors shadow-md">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const actionSelect = document.getElementById('action-select');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        const submitContainer = document.getElementById('submit-container');
        const form = document.getElementById('meter-form');
        const formContainer = document.getElementById('form-container');
        const passwordSection = document.getElementById('password-section');
        const passwordInput = document.getElementById('password');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const errorMessage = document.getElementById('error-message');

        // IMPORTANT: Change this password to a secure one.
        const CORRECT_PASSWORD = "pass123";

        // Password check logic
        passwordSubmitBtn.addEventListener('click', () => {
            if (passwordInput.value === CORRECT_PASSWORD) {
                passwordSection.classList.add('hidden');
                formContainer.classList.remove('hidden');
            } else {
                errorMessage.classList.remove('hidden');
                passwordInput.value = '';
            }
        });
        
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                passwordSubmitBtn.click();
            }
        });

        // Function to create a form field
        // Updated to include a 'name' attribute which matches the Google Sheet header
        function createField(label, type, id, name, placeholder = '') {
            const valueAttribute = type === 'number' ? 'value="0"' : '';
            return `
                <div>
                    <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                    <input type="${type}" id="${id}" name="${name}" placeholder="${placeholder}" ${valueAttribute}
                           class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors" required>
                </div>
            `;
        }

        // Handle dropdown change event
        actionSelect.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            dynamicFieldsContainer.innerHTML = '';
            submitContainer.classList.add('hidden');

            if (selectedValue) {
                submitContainer.classList.remove('hidden');
                
                let html = '';
                if (selectedValue === 'issuedByGenus') {
                    // Updated `createField` calls with the correct `name` attribute
                    html += createField('Date of Issue:', 'date', 'issue-date-genus', 'Date of Issue');
                    html += createField('Auto Fare Paid:', 'number', 'auto-fare', 'Auto Fare Paid', 'in INR');
                    html += createField('RF 1Phase METERS:', 'number', 'rf-1phase', 'RF 1Phase METERS');
                    html += createField('4G 1Phase METERS:', 'number', '4g-1phase', '4G 1Phase METERS');
                    html += createField('RF 3Phase METERS:', 'number', 'rf-3phase', 'RF 3Phase METERS');
                    html += createField('4G 3Phase METERS:', 'number', '4g-3phase', '4G 3Phase METERS');
                    html += createField('LTCT:', 'number', 'ltct-meters', 'LTCT');
                    html += createField('HTCT:', 'number', 'htct-meters', 'HTCT');
                } else if (selectedValue === 'issuedToSupervisor') {
                    // Updated `createField` calls with the correct `name` attribute
                    html += createField('Date of Issue:', 'date', 'issue-date-to-sup', 'Date of Issue');
                    html += createField('Issued To:', 'text', 'issued-to-sup', 'Issued To');
                    html += createField('Issued By:', 'text', 'issued-by-sup', 'Issued By');
                    html += createField('Division:', 'text', 'division-to-sup', 'Division');
                    html += createField('RF 1Phase METERS:', 'number', 'rf-1phase-to-sup', 'RF 1Phase METERS');
                    html += createField('4G 1Phase METERS:', 'number', '4g-1phase-to-sup', '4G 1Phase METERS');
                    html += createField('RF 3Phase METERS:', 'number', 'rf-3phase-to-sup', 'RF 3Phase METERS');
                    html += createField('4G 3Phase METERS:', 'number', '4g-3phase-to-sup', '4G 3Phase METERS');
                    html += createField('LTCT:', 'number', 'ltct-meters-to-sup', 'LTCT');
                    html += createField('HTCT:', 'number', 'htct-meters-to-sup', 'HTCT');
                } else if (selectedValue === 'receivedFromSupervisor') {
                    // Updated `createField` calls with the correct `name` attribute
                    html += createField('Date:', 'date', 'receive-date', 'Date');
                    html += createField('Received from:', 'text', 'received-from', 'Received from');
                    html += createField('Received by:', 'text', 'received-by', 'Received by');
                    html += createField('Division:', 'text', 'division-from-sup', 'Division');
                    html += createField('Number of Meters:', 'number', 'number-of-meters-from-sup', 'Number of Meters');
                    html += createField('Comments:', 'text', 'comments-from-sup', 'Comments');
                }
                dynamicFieldsContainer.innerHTML = html;
            }
        });

        // Handle form submission
        form.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent the form from refreshing the page
            
            // Collect form data
            const formData = new FormData(form);
            const urlSearchParams = new URLSearchParams(formData);
            
            // Log the collected data to the console for demonstration
            console.log("Form Submitted:", Object.fromEntries(formData.entries()));

            // Using a fetch call with URLSearchParams.
            fetch(form.action, {
                method: 'POST',
                body: urlSearchParams, // Use the URL-encoded string
                mode: 'no-cors'
            }).then(response => {
                alert('Form submitted successfully!');
                form.reset();
                dynamicFieldsContainer.innerHTML = '';
                submitContainer.classList.add('hidden');
                passwordSection.classList.remove('hidden');
                formContainer.classList.add('hidden');
            }).catch(error => {
                console.error('Error submitting form:', error);
                alert('An error occurred during submission.');
            });
        });

        // Custom alert function to avoid using the native alert() which is not allowed in this environment
        function alert(message) {
            const container = document.body;
            const alertBox = document.createElement('div');
            alertBox.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            alertBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-4">
                    <p class="text-lg font-semibold mb-4">${message}</p>
                    <button id="close-alert" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition-colors">OK</button>
                </div>
            `;
            container.appendChild(alertBox);

            document.getElementById('close-alert').addEventListener('click', () => {
                container.removeChild(alertBox);
            });
        }
    </script>
</body>
</html>
